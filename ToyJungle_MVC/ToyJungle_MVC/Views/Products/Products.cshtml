
@{
    ViewBag.Title = "Point of Sale";
}
<script src="~/assets/alertifyjs/alertify.min.js "></script>
<link rel="stylesheet" href="~/assets/alertifyjs/css/alertify.min.css" />
<link rel="stylesheet" href="/assets/alertifyjs/css/themes/default.min.css" />
<script src="~/assets/js/angular.min.js"></script>
<script src="~/assets/js/angular-sanitize.min.js"></script>
<script>

    var app = angular.module("myApp", []);


    app.controller("customersCtrl", function ($scope, $http, $location) {
            var BaseUrl = "https://localhost:44393/";
            $scope.BaseUrl= "https://localhost:44393/";

            var HttpSetting = { "Accept": "application/json" };
            $http.defaults.headers.post["Content-Type"] = "application/json";
            $scope.Index = -1;
            $scope.EditMode = false;
            $scope.Keyword = "";

            $scope.Product = {productName:"",brand:"",price:0};
            $scope.SelectedProducts = [];
            $scope.Products = [];
            $scope.ProductImage = null;


            $scope.Load = function () {

                $http.get(BaseUrl + "api/products")
                    .then(function (response) {
                        console.log(response.data);
                        $scope.Products = response.data;
                       $scope.ShowPanel = "List";

                    }, function (response) {
                        alert(angular.toJson(response));
                    });


            }
            $scope.Load();

            $scope.Delete = function (Product) {

                if (!confirm("Are you sure want to delete this product ?")) {
                    $scope.SelectProduct(Product);
                    return;
                }
                var id = Product.pid;

                $http.get(BaseUrl + "api/products/delete/" + id).then(function (response) {
                    $scope.Products.splice($scope.Products.indexOf(Product), 1);
                    $scope.Load();
                    alertify.error('Product Deleted');
                });

            }
            $scope.Discard = function () {
                $scope.Product = {};
                $scope.Index = null;
                $scope.ProductImage = null;
                $scope.EditMode = false;
                $scope.ShowPanel = "List";
               // $('#ProductModal').modal('hide');
            }

            $scope.SetShowPanel = function(Panel) { $scope.ShowPanel = Panel; }

            $scope.Save = function () {

                console.log('product',$scope.ProductImage);
                    var fd = new FormData();
                    fd.append("ProductName", $scope.Product.productName);
                    fd.append("price", $scope.Product.price);
                fd.append("Brand", $scope.Product.brand);
                fd.append("Description", $scope.Product.description);
                    fd.append("PID", $scope.Product.pid);
                    fd.append("file", $scope.ProductImage);
                if (!$scope.EditMode) {


                    $http.post(BaseUrl + "api/products/create", fd, {
                        //withCredentials: true,
                        headers: { 'Content-Type': undefined },
                        enctype: 'multipart/form-data',
                        transformRequest: angular.identity
                    }).then(function(response) {
                        console.log(response.data);
                         $scope.Load();
                    });

                }
                else {
                    $http.post(BaseUrl + "api/products/update", fd, {
                        //withCredentials: true,
                        headers: { 'Content-Type': undefined },
                        enctype: 'multipart/form-data',
                        transformRequest: angular.identity
                    }).then(function(response) {
                        console.log(response.data);
                         $scope.Load();
                    });

                }




            }

            $scope.SetToUpdate = function (Product) {

                $scope.EditMode = true;
                $scope.Index = $scope.Products.indexOf(Product);
                $scope.Product = angular.copy( Product);
                console.log($scope.Product);
                $scope.ShowPanel = "Edit";
                //$('#ProductModal').modal('show');
                $scope.ProductImage = null;
                //$('#ProductImage').val(null);
            }
            $scope.SaveFiles = function (Files) {
                $scope.ProductImage = Files[0];
                console.log('product',$scope.ProductImage);
            }
            $scope.UploadProductImage = function (PID) {
                var fd = new FormData();
                fd.append("ProductImage", $scope.ProductImage);
                fd.append("PID", PID);
                console.log(PID);
                uploadUrl = $http.post(BaseUrl + "AddProductImage", fd, {
                    //withCredentials: true,
                    headers: { 'Content-Type': undefined },
                    enctype: 'multipart/form-data',
                    //transformRequest: angular.identity
                }).then(function (response) {
                    // alert(response);
                    //  alertify.success("Image uploaded");
                    $scope.Discard();
                });
            }

            $scope.Logout = function () {

                alertify.confirm('Confirmation', 'Logout ... Are you sure ?', function () {
                    localStorage.removeItem('User');

                    $scope.IsLoggedIn = false; $scope.ShowFootbar = false;

                    window.location.assign('login.html');

                    alertify.error('Logged Out');
                }
                    , function () { });

            }

    });
</script>

<div ng-app="myApp" onload="Load()" ng-controller="customersCtrl">
    <div class="container d-xl-flex align-items-xl-center" style="margin-top: 20px;">
        <h4 class="flex-fill">Products</h4>
        <div class="input-group" style="width: 495px;">
            <input type="text" class="form-control" ng-model="Keyword" placeholder="Search Product Name / Brand" />
        </div>
    </div>
    <hr />
    {{}}
    <div class="container" style="margin-top: 20px;" ng-show="ShowPanel=='List'">
        <div class="card">
            <div class="card-header"><button class="btn btn-dark" ng-click="SetShowPanel('Edit')" type="button">Add Product</button></div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th style="width: 50px;">Sn.</th>

                            <th>Image</th>
                            <th>Product Name</th>
                            <th>Brand</th>
                            <th style="width: 259px;">Price</th>
                            <th class="text-center" style="width: 150px;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-dblclick="SetToUpdate($index)" ng-click="SelectProduct(Product)" ng-repeat="Product in Products | filter : Keyword"
                            ng-class="SelectedProducts.includes(Product)?'table-success':''">
                            <td>{{$index+1}}</td>
                            <td class="text-center p-1">
                                <img ng-src="{{'https://localhost:44393/api/products/images/' + Product.pid+ '?t=' + Date.now() }}" style="max-width: 40px;" />
                            </td>
                            <td>{{Product.productName}}</td>
                            <td>{{Product.brand}}</td>
                            <td>{{Product.price}}</td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-primary" ng-click="SetToUpdate(Product)" type="button">Update</button>
                                    <button class="btn btn-danger" ng-click="Delete(Product)" type="button">Delete</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="10">Summary 1</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    {{Image}}


    <div class="container" style="margin-top: 20px;" ng-hide="ShowPanel=='List'">
        <div class="row">
            <div class="col-8">
                <div class="card">
                    <div class="card-header">
                        <button class="btn btn-dark" ng-click="Discard()" type="button">Back</button>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="form-group"><label>Product Name</label><input type="text" ng-model="Product.productName" class="form-control" placeholder="Enter Product Name" /></div>
                            <div class="form-group"><label>Description</label><input type="text" ng-model="Product.description" class="form-control" placeholder="Description" /></div>
                            <div class="form-group"><label>Brand</label><input type="text" ng-model="Product.brand" class="form-control" placeholder="Product Brand Company" /></div>
                            <div class="form-group"><label>Price</label><input type="text" ng-model="Product.price" class="form-control" placeholder="Price" /></div>
                            <div class="form-group">
                                <label>Product Image</label>
                                <input name="ProductImage" id="ProductImage"
                                       onchange="angular.element(this).scope().SaveFiles(this.files)" type="file">
                            </div>

                            <div class="form-group"><button class="btn btn-primary btn-block" ng-click="Save()" type="button">Save</button></div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>